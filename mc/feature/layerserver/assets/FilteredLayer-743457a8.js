var u=Object.defineProperty;var p=(f,e,t)=>e in f?u(f,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):f[e]=t;var l=(f,e,t)=>(p(f,typeof e!="symbol"?e+"":e,t),t);import{U as d,L as g}from"./LocalStorageSource-4f66d5e4.js";import{Q as h}from"./Translation-5455689e.js";import{U as c}from"./Utils-498bb79d.js";import{d as m,A as T}from"./LayerConfig-36f1a6a1.js";class a{constructor(e,t,i){l(this,"isDisplayed");l(this,"appliedFilters");l(this,"layerDef");l(this,"hasFilter");l(this,"currentFilter");if(this.layerDef=e,this.isDisplayed=i??new d(!0),!t){const r=new Map;for(const o of this.layerDef.filters)r.set(o.id,new d(void 0));t=r}this.appliedFilters=t;const s=this,n=new d(void 0);this.appliedFilters.forEach(r=>{r.addCallbackAndRun(o=>{n.setData(s.calculateCurrentTags())})}),this.hasFilter=n.map(r=>r!==void 0),this.currentFilter=n}static fieldsToString(e){for(const t in e)e[t]===""&&delete e[t];return JSON.stringify(e)}static queryParameterKey(e){return"layer-"+e.id}static initLinkedState(e,t,i){let s;e.syncSelection==="local"?s=g.GetParsed(t+"-layer-"+e.id+"-enabled",e.shownByDefault):e.syncSelection==="theme-only"?s=a.getPref(i,t+"-layer-"+e.id+"-enabled",e):e.syncSelection==="global"?s=a.getPref(i,"layer-"+e.id+"-enabled",e):s=h.GetBooleanQueryParameter(a.queryParameterKey(e),e.shownByDefault,"Whether or not layer "+e.id+" is shown");const n=new Map;for(const r of e.filters)n.set(r.id,r.initState(e.id));return new a(e,n,s)}static stringToFieldProperties(e){const t=JSON.parse(e);for(const i in t)t[i]===""&&delete t[i];return t}static fieldsToTags(e,t){let i;if(typeof t=="string"?i=a.stringToFieldProperties(t):i=t,e.fields.map(r=>r.name).filter(r=>i[r]===void 0).length>0)return;const n=c.WalkJson(e.originalTagsSpec,r=>{if(typeof r!="string")return r;for(const o in i)r=r.replace("{"+o+"}",i[o]);return r});return m.Tag(n)}static getPref(e,t,i){return e.GetPreference(t,i.shownByDefault+"").sync(s=>{if(s!==void 0)return s==="true"},[],s=>{if(s!==void 0)return""+s})}disableAllFilters(){this.appliedFilters.forEach(e=>e.setData(void 0))}isShown(e,t){if(e._deleted==="yes")return!1;for(const i of t??[]){const s=i.osmTags;if(s!==void 0&&!s.matchesProperties(e))return!1}{const i=this.layerDef.isShown;if(i!==void 0&&!i.matchesProperties(e))return!1}{let i=this.currentFilter.data;if(i!==void 0&&!i.matchesProperties(e))return!1}return!0}calculateCurrentTags(){let e=[];for(const s of this.layerDef.filters){const n=this.appliedFilters.get(s.id);if(n.data!==void 0){if(s.options[0].fields.length>0){const r=a.stringToFieldProperties(n.data),o=a.fieldsToTags(s.options[0],r);o&&e.push(o);continue}e.push(s.options[n.data].osmTags)}}if(e=c.NoNull(e),e.length==0)return;let t;e.length==1?t=e[0]:t=new T(e);let i=t.optimize();if(i!==!0)return i===!1?t:i}}export{a as F};
//# sourceMappingURL=FilteredLayer-743457a8.js.map
